generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String     @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User?      @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Account_userId_fkey")
  adminUser         AdminUser? @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Account_adminUserId_fkey")

  @@unique([provider, providerAccountId])
}

model Session {
  id           String     @id @default(cuid())
  sessionToken String     @unique
  userId       String
  expires      DateTime
  user         User?      @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Session_userId_fkey")
  adminUser    AdminUser? @relation(fields: [userId], references: [id], onDelete: Cascade, map: "Session_adminUserId_fkey")
}

model User {
  id                 String       @id @default(cuid())
  name               String?
  firstName          String?
  lastName           String?
  email              String       @unique
  organization       String?
  password           String?
  emailVerified      DateTime?
  image              String?
  activationToken    String?      @unique
  activationExpires  DateTime?
  resetToken         String?      @unique
  resetExpires       DateTime?
  companyId          String? // FK to Company
  accounts           Account[]
  auditLogs          AuditLog[]
  createdInvitations Invitation[] @relation("InvitationCreator")
  memberships        Membership[]
  sessions           Session[]
  company            Company?     @relation(fields: [companyId], references: [id])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Organization {
  id                 String              @id @default(cuid())
  name               String
  logo               String?
  timezone           String              @default("UTC")
  businessHours      Json? // Store business hours as JSON
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  appointments       Appointment[]
  auditLogs          AuditLog[]
  complaints         Complaint[]
  contacts           Contact[]
  invitations        Invitation[]
  memberships        Membership[]
  n8nConfig          OrganizationN8n?
  retellConfig       OrganizationRetell?
  callLogs           CallLog[]
  workflowExecutions WorkflowExecution[]
}

model Membership {
  id     String       @id @default(cuid())
  userId String
  orgId  String
  role   Role
  org    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
}

model Invitation {
  id         String       @id @default(cuid())
  orgId      String
  email      String
  role       Role
  token      String       @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdBy  String
  createdAt  DateTime     @default(now())
  creator    User         @relation("InvitationCreator", fields: [createdBy], references: [id])
  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id        String       @id @default(cuid())
  orgId     String
  actorId   String
  action    String
  target    String?
  ip        String?
  userAgent String?
  createdAt DateTime     @default(now())
  actor     User         @relation(fields: [actorId], references: [id])
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Contact {
  id        String       @id @default(cuid())
  orgId     String
  name      String
  email     String?
  phone     String?
  tags      String[]     @default([])
  notes     String?
  source    String? // Source of the contact (e.g., "calendar", "manual", "import")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Complaint {
  id            String          @id @default(cuid())
  orgId         String
  phoneNumber   String
  callTimestamp DateTime
  description   String?
  status        ComplaintStatus @default(OPEN)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  org           Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model Appointment {
  id            String            @id @default(cuid())
  orgId         String
  title         String
  customerName  String
  customerPhone String?
  customerEmail String?
  startsAt      DateTime
  endsAt        DateTime
  status        AppointmentStatus @default(SCHEDULED)
  source        AppointmentSource @default(AGENT)
  description   String?
  notes         String?
  googleEventId String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  org           Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

enum Role {
  OWNER
  MANAGER
  AGENT
}

enum ComplaintStatus {
  OPEN
  RESOLVED
  CLOSED
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELED
  NO_SHOW
}

enum AppointmentSource {
  WEB
  PHONE
  AGENT
  IMPORTED
}

// Tenant configuration for Google Sheets integration
model Company {
  id               String   @id @default(cuid())
  name             String   @unique
  googleSheetId    String? // Google Sheets ID for this company
  retellWebhookUrl String? // Retell webhook URL for this company
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  users  User[]
  sheets CompanySheet[]
  phones CompanyPhone[]
  cache  SheetCache[]
  retell CompanyRetell[]
}

model CompanySheet {
  id            String   @id @default(cuid())
  companyId     String
  spreadsheetId String
  dataRange     String   @default("Calls!A:H")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId])
}

model CompanyPhone {
  id        String   @id @default(cuid())
  companyId String
  e164      String // E.164 format phone number
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, e164])
}

// Optional cache for analytics performance
model SheetCache {
  id         String   @id @default(cuid())
  companyId  String
  lastSynced DateTime
  rowCount   Int
  createdAt  DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId])
}

// Retell workflow configuration for each company
model CompanyRetell {
  id         String   @id @default(cuid())
  companyId  String
  workflowId String // Retell workflow ID
  apiKey     String // Retell API key for this company
  webhookUrl String? // Optional webhook URL for real-time updates
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId])
}

// Admin users for the admin panel (separate from regular users)
model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts Account[]
  sessions Session[]
}

// ============================================
// AI RECEPTIONIST INTEGRATION MODELS
// ============================================

// n8n workflow configuration per organization
// Each org gets their own n8n workflow for custom automation
model OrganizationN8n {
  id             String   @id @default(cuid())
  orgId          String   @unique
  n8nInstanceUrl String // n8n instance URL (shared or dedicated)
  workflowId     String // Unique workflow ID for this organization
  apiKey         String // Encrypted n8n API key
  webhookUrl     String? // Webhook endpoint for n8n callbacks
  webhookSecret  String? // Secret for webhook validation
  isActive       Boolean  @default(true)
  metadata       Json? // Additional workflow configuration
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
}

// Retell AI agent configuration per organization
// Each org gets their own AI receptionist with custom voice/prompts
model OrganizationRetell {
  id                String   @id @default(cuid())
  orgId             String   @unique
  retellAgentId     String // Unique Retell agent ID per organization
  retellPhoneNumber String? // Dedicated phone number (E.164 format)
  apiKey            String // Encrypted Retell API key
  webhookSecret     String // Secret for webhook signature validation
  voiceId           String? // Retell voice ID (e.g., "11labs-Adrian")
  language          String   @default("en-US")
  customPrompt      String?  @db.Text // Organization-specific AI prompt
  callSettings      Json? // Additional settings (speed, interruption, etc.)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([retellAgentId])
}

// Call logs per organization (isolated data)
// All call data from Retell AI stored here for analytics and billing
model CallLog {
  id            String      @id @default(cuid())
  orgId         String
  callId        String      @unique // Retell call ID
  retellAgentId String // Which agent handled this call
  customerPhone String // Customer phone number (E.164)
  customerName  String? // Extracted from call if available
  duration      Int // Call duration in seconds
  status        CallStatus  @default(COMPLETED)
  intent        CallIntent? // booking, quote, complaint, etc.
  transcript    String?     @db.Text // Full call transcript
  summary       String?     @db.Text // AI-generated summary
  sentiment     String? // positive, neutral, negative
  recordingUrl  String? // URL to call recording
  timeSaved     Int? // Estimated time saved in seconds
  costUSD       Decimal?    @db.Decimal(10, 4) // Cost of this call
  metadata      Json? // Additional custom data
  createdAt     DateTime    @default(now())

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt])
  @@index([customerPhone])
  @@index([intent])
  @@index([status])
}

// n8n workflow execution logs
// Track all workflow runs for debugging and billing
model WorkflowExecution {
  id           String         @id @default(cuid())
  orgId        String
  workflowId   String // n8n workflow ID
  executionId  String         @unique // n8n execution ID
  trigger      String // webhook, schedule, manual
  status       WorkflowStatus @default(RUNNING)
  input        Json? // Input data to workflow
  output       Json? // Output data from workflow
  errorMessage String?        @db.Text
  startedAt    DateTime
  completedAt  DateTime?
  durationMs   Int? // Execution time in milliseconds

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, startedAt])
  @@index([status])
  @@index([workflowId])
}

// Enums for AI Receptionist features
enum CallStatus {
  COMPLETED
  FAILED
  CANCELLED
  IN_PROGRESS
  NO_ANSWER
}

enum CallIntent {
  BOOKING // Customer wants to book appointment
  RESCHEDULE // Customer wants to reschedule
  CANCELLATION // Customer wants to cancel
  QUOTE // Customer asking for pricing
  INFORMATION // General inquiry
  COMPLAINT // Customer complaint
  OTHER // Other intent
}

enum WorkflowStatus {
  RUNNING
  SUCCESS
  ERROR
  CANCELLED
  WAITING
}
